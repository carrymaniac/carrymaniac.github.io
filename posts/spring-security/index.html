<!DOCTYPE html>
<html lang="zh-hans">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#494f5c">
	<meta name="msapplication-TileColor" content="#494f5c">
<meta itemprop="name" content="Spring Security">
<meta itemprop="description" content="JWT 流程  客户端使用用户名和密码请求登录 服务端收到请求后会去验证用户名和密码，如果用户名和密码跟数据库记录不一致则验证失败，如果一致则验证通过，服务端会签发一个 Token 返回给客户端 客户端收到请求后会将 Token 缓存起来，比如放在浏览器 Cookie 中或者本地存储中，之后每次请求都会携带该 Token 服务端收到请求后会验证请求中携带的 Token，验证通过则进行业务逻辑处理并成功返回数据  jwt,即JSON WEB TOKEN，它是基于 RFC 7519 标准定义的一种可以安全传输的的JSON对象，由于使用了数字签名，所以是可信任和安全的。
格式 在 JWT 中，Token 有三部分组成，中间用 . 隔开，并使用 Base64 编码：
 header.payload.signature
 其中：
 header用于存放  Token 的类型 Token 所使用的加密算法    { &#34;typ&#34;: &#34;JWT&#34;, &#34;alg&#34;: &#34;HS256&#34; } 该例说明 Token 类型是 JWT，加密算法是 HS256（alg 算法可以有多种）。
  payload
Payload 中携带 Token 的具体内容，里面有一些标准的字段，当然你也可以添加额外的字段，来表达更丰富的信息，可以用这些信息来做更丰富的处理，比如记录请求用户名，标准字段有：
 iss：JWT Token 的签发者 sub：主题 exp：JWT Token 过期时间 aud：接收 JWT Token 的一方 iat：JWT Token 签发时间 nbf：JWT Token 生效时间 jti：JWT Token ID    { &#34;id&#34;: 2, &#34;username&#34;: &#34;kong&#34;, &#34;nbf&#34;: 1527931805, &#34;iat&#34;: 1527931805 } {&#34;sub&#34;:&#34;admin&#34;, &#34;iat&#34;:1489079981393, &#34;exp&#34;:1489684781}   signature">
<meta itemprop="datePublished" content="2020-04-27T17:17:30&#43;08:00" />
<meta itemprop="dateModified" content="2020-04-27T17:17:30&#43;08:00" />
<meta itemprop="wordCount" content="1285">



<meta itemprop="keywords" content="spring," /><meta property="og:title" content="Spring Security" />
<meta property="og:description" content="JWT 流程  客户端使用用户名和密码请求登录 服务端收到请求后会去验证用户名和密码，如果用户名和密码跟数据库记录不一致则验证失败，如果一致则验证通过，服务端会签发一个 Token 返回给客户端 客户端收到请求后会将 Token 缓存起来，比如放在浏览器 Cookie 中或者本地存储中，之后每次请求都会携带该 Token 服务端收到请求后会验证请求中携带的 Token，验证通过则进行业务逻辑处理并成功返回数据  jwt,即JSON WEB TOKEN，它是基于 RFC 7519 标准定义的一种可以安全传输的的JSON对象，由于使用了数字签名，所以是可信任和安全的。
格式 在 JWT 中，Token 有三部分组成，中间用 . 隔开，并使用 Base64 编码：
 header.payload.signature
 其中：
 header用于存放  Token 的类型 Token 所使用的加密算法    { &#34;typ&#34;: &#34;JWT&#34;, &#34;alg&#34;: &#34;HS256&#34; } 该例说明 Token 类型是 JWT，加密算法是 HS256（alg 算法可以有多种）。
  payload
Payload 中携带 Token 的具体内容，里面有一些标准的字段，当然你也可以添加额外的字段，来表达更丰富的信息，可以用这些信息来做更丰富的处理，比如记录请求用户名，标准字段有：
 iss：JWT Token 的签发者 sub：主题 exp：JWT Token 过期时间 aud：接收 JWT Token 的一方 iat：JWT Token 签发时间 nbf：JWT Token 生效时间 jti：JWT Token ID    { &#34;id&#34;: 2, &#34;username&#34;: &#34;kong&#34;, &#34;nbf&#34;: 1527931805, &#34;iat&#34;: 1527931805 } {&#34;sub&#34;:&#34;admin&#34;, &#34;iat&#34;:1489079981393, &#34;exp&#34;:1489684781}   signature" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://carrymaniac.github.io/posts/spring-security/" />
<meta property="article:published_time" content="2020-04-27T17:17:30+08:00" />
<meta property="article:modified_time" content="2020-04-27T17:17:30+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Spring Security"/>
<meta name="twitter:description" content="JWT 流程  客户端使用用户名和密码请求登录 服务端收到请求后会去验证用户名和密码，如果用户名和密码跟数据库记录不一致则验证失败，如果一致则验证通过，服务端会签发一个 Token 返回给客户端 客户端收到请求后会将 Token 缓存起来，比如放在浏览器 Cookie 中或者本地存储中，之后每次请求都会携带该 Token 服务端收到请求后会验证请求中携带的 Token，验证通过则进行业务逻辑处理并成功返回数据  jwt,即JSON WEB TOKEN，它是基于 RFC 7519 标准定义的一种可以安全传输的的JSON对象，由于使用了数字签名，所以是可信任和安全的。
格式 在 JWT 中，Token 有三部分组成，中间用 . 隔开，并使用 Base64 编码：
 header.payload.signature
 其中：
 header用于存放  Token 的类型 Token 所使用的加密算法    { &#34;typ&#34;: &#34;JWT&#34;, &#34;alg&#34;: &#34;HS256&#34; } 该例说明 Token 类型是 JWT，加密算法是 HS256（alg 算法可以有多种）。
  payload
Payload 中携带 Token 的具体内容，里面有一些标准的字段，当然你也可以添加额外的字段，来表达更丰富的信息，可以用这些信息来做更丰富的处理，比如记录请求用户名，标准字段有：
 iss：JWT Token 的签发者 sub：主题 exp：JWT Token 过期时间 aud：接收 JWT Token 的一方 iat：JWT Token 签发时间 nbf：JWT Token 生效时间 jti：JWT Token ID    { &#34;id&#34;: 2, &#34;username&#34;: &#34;kong&#34;, &#34;nbf&#34;: 1527931805, &#34;iat&#34;: 1527931805 } {&#34;sub&#34;:&#34;admin&#34;, &#34;iat&#34;:1489079981393, &#34;exp&#34;:1489684781}   signature"/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>Spring Security</title>
	<link rel="stylesheet" href="https://carrymaniac.github.io/css/style.min.657bcb7af31123e4156b1a3d2ff60a636717e54ead74f882136b5114cf72b55e.css" integrity="sha256-ZXvLevMRI+QVaxo9L/YKY2cX5U6tdPiCE2tRFM9ytV4=" crossorigin="anonymous">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp faster">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://carrymaniac.github.io/">UnhappyBrain</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					
				<a href="https://carrymaniac.github.io/posts/">文章</a>
				<a href="https://carrymaniac.github.io/tags/">标签</a>
				<a href="https://carrymaniac.github.io/about/">关于我</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<button id="toc-btn" class="hdr-btn desktop-only-ib" title="Table of Contents"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-list"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3" y2="6"></line><line x1="3" y1="12" x2="3" y2="12"></line><line x1="3" y1="18" x2="3" y2="18"></line></svg></button><span class="hdr-social hide-in-mobile"><a href="https://github.com/carrymaniac" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></span><button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://carrymaniac.github.io/posts/">文章</a></li>
			<li><a href="https://carrymaniac.github.io/tags/">标签</a></li>
			<li><a href="https://carrymaniac.github.io/about/">关于我</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Apr 27, 2020</span></div>
				<h1>Spring Security</h1>
			</header>
			<div class="content">
				<h2 id="jwt">JWT<a href="#jwt" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<h3 id="流程">流程<a href="#流程" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<ol>
<li>客户端使用用户名和密码请求登录</li>
<li>服务端收到请求后会去验证用户名和密码，如果用户名和密码跟数据库记录不一致则验证失败，如果一致则验证通过，服务端会签发一个 Token 返回给客户端</li>
<li>客户端收到请求后会将 Token 缓存起来，比如放在浏览器 Cookie 中或者本地存储中，之后每次请求都会携带该 Token</li>
<li>服务端收到请求后会验证请求中携带的 Token，验证通过则进行业务逻辑处理并成功返回数据</li>
</ol>
<p>jwt,即JSON WEB TOKEN，它是基于 RFC 7519 标准定义的一种可以安全传输的的JSON对象，由于使用了数字签名，所以是可信任和安全的。</p>
<h3 id="格式">格式<a href="#格式" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>在 JWT 中，Token 有三部分组成，中间用 . 隔开，并使用 Base64 编码：</p>
<blockquote>
<p>header.payload.signature</p>
</blockquote>
<p>其中：</p>
<ul>
<li>header用于存放
<ol>
<li>Token 的类型</li>
<li>Token 所使用的加密算法</li>
</ol>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;typ&#34;</span><span class="p">:</span> <span class="s2">&#34;JWT&#34;</span><span class="p">,</span>
  <span class="nt">&#34;alg&#34;</span><span class="p">:</span> <span class="s2">&#34;HS256&#34;</span>
<span class="p">}</span>
</code></pre></div><p>该例说明 Token 类型是 JWT，加密算法是 HS256（alg 算法可以有多种）。</p>
<ul>
<li>
<p>payload</p>
<p>Payload 中携带 Token 的具体内容，里面有一些标准的字段，当然你也可以添加额外的字段，来表达更丰富的信息，可以用这些信息来做更丰富的处理，比如记录请求用户名，标准字段有：</p>
<ul>
<li>iss：JWT Token 的签发者</li>
<li>sub：主题</li>
<li>exp：JWT Token 过期时间</li>
<li>aud：接收 JWT Token 的一方</li>
<li>iat：JWT Token 签发时间</li>
<li>nbf：JWT Token 生效时间</li>
<li>jti：JWT Token ID</li>
</ul>
</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
 <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
 <span class="nt">&#34;username&#34;</span><span class="p">:</span> <span class="s2">&#34;kong&#34;</span><span class="p">,</span>
 <span class="nt">&#34;nbf&#34;</span><span class="p">:</span> <span class="mi">1527931805</span><span class="p">,</span>
 <span class="nt">&#34;iat&#34;</span><span class="p">:</span> <span class="mi">1527931805</span>
<span class="p">}</span>
<span class="p">{</span><span class="nt">&#34;sub&#34;</span><span class="p">:</span><span class="s2">&#34;admin&#34;</span><span class="p">,</span>
 <span class="nt">&#34;iat&#34;</span><span class="p">:</span><span class="mi">1489079981393</span><span class="p">,</span>
 <span class="nt">&#34;exp&#34;</span><span class="p">:</span><span class="mi">1489684781</span><span class="p">}</span>
</code></pre></div><ul>
<li>
<p>signature</p>
<p>Signature 是 Token 的签名部分，通过如下方式生成：</p>
<ol>
<li>用 Base64 对 header.payload 进行编码</li>
<li>用 Secret 对编码后的内容进行加密，加密后的内容即为 Signature</li>
</ol>
<p>是以header和payload生成的签名，一旦header和payload被篡改，验证将失败</p>
<p>Secret 相当于一个密码，存储在服务端，一般通过配置文件来配置 Secret 的值</p>
</li>
</ul>
<p>最后生成的token大概长得像这样</p>
<pre><code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE1MjgwMTY5MjIsImlkIjowLCJuYmYiOjE1MjgwMTY5MjIsInVzZXJuYW1lIjoiYWRtaW4ifQ.LjxrK9DuAwAzUD8-9v43NzWBN7HXsSLfebw92DKd1JQ
</code></pre><p>签名后服务端会返回生成的 Token，客户端下次请求会携带该 Token，服务端收到 Token 后会解析出 header.payload，然后用相同的加密算法和密码对 header.payload 再进行一次加密，并对比加密后的 Token 和收到的 Token 是否相同，如果相同则验证通过，不相同则返回 HTTP 401 Unauthorized 的错误。</p>
<h3 id="如何进行验证">如何进行验证<a href="#如何进行验证" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>API 身份认证包括两步：</p>
<ol>
<li>登录成功时签发 token</li>
<li>API 添加认证中间件（拦截器）</li>
</ol>
<h2 id="springsecurity">SpringSecurity<a href="#springsecurity" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>在我看来，学习SpringSecurity有两个词需要先认清：</p>
<p>认证(Authentication):是建立一个他声明的主体的过程,告知浏览器</p>
<p>授权(Authorization)即确认一个主体是否允许执行某个动作的权限</p>
<p>认证就是我们翻译过来就是 “你是谁”，我们可以理解为登录，而授权则是登陆过后明白自己有哪些事情可以做，我们可以理解为 ”你可以做什么“，而在springsecurity将这两者完全分开，并且提供了不同的策略去定义它们。</p>
<p><code>authentication</code>和<code>authorization</code></p>
<p>authentication指认证，即确认你的身份这件事情，换到应用上来说，即解决你是否登录，是否为有效用户的事情</p>
<p>而authorization指的是授权，即确认你是否有这个权限的事情，在应用的层面上说，即解决你是否有这个权限。</p>
<p>从代码开始看吧:</p>
<h2 id="代码实践">代码实践<a href="#代码实践" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<h3 id="user实体类">User实体类<a href="#user实体类" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.gdou.security.entity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.GrantedAuthority</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.userdetails.UserDetails</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @ProjectName: security
</span><span class="cm"> * @Package: com.gdou.security.entity
</span><span class="cm"> * @ClassName: User
</span><span class="cm"> * @Author: carrymaniac
</span><span class="cm"> * @Description: user 实体类 需要继承UserDetails，并实现getAuthorities()方法，该方法为返回用户的&#34;权限&#34;
</span><span class="cm"> * @Date: 2020/2/11 2:26 下午
</span><span class="cm"> * @Version:
</span><span class="cm"> */</span>
<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="kd">implements</span> <span class="n">UserDetails</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">salt</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">type</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">status</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">activationCode</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">headerUrl</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">createTime</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 获取权限 可用对type进行判断返回权限 此处处理为根据Type类型返回权限
</span><span class="cm">     * @return
</span><span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">getAuthorities</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(()-&gt;{</span>
            <span class="k">switch</span> <span class="o">(</span><span class="n">type</span><span class="o">){</span>
                <span class="k">case</span> <span class="n">1</span><span class="o">:</span>
                    <span class="k">return</span> <span class="s">&#34;ADMIN&#34;</span><span class="o">;</span>
                <span class="k">default</span><span class="o">:</span>
                    <span class="k">return</span> <span class="s">&#34;USER&#34;</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="k">return</span> <span class="n">list</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 获取密码
</span><span class="cm">     * @return
</span><span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getPassword</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">password</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 获取用户名
</span><span class="cm">     * @return
</span><span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getUsername</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">username</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 账号是否过期
</span><span class="cm">     * @return
</span><span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isAccountNonExpired</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 账号是否锁定
</span><span class="cm">     * @return
</span><span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isAccountNonLocked</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 凭证是否过期
</span><span class="cm">     * @return
</span><span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isCredentialsNonExpired</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 账号是否可用
</span><span class="cm">     * @return
</span><span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEnabled</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div><h3 id="userservice">UserService<a href="#userservice" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Service</span>
<span class="c1">//UserService实现了UserDetailsService接口，里面只有一个方法loadUserByUsername
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserService</span> <span class="kd">implements</span> <span class="n">UserDetailsService</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="n">UserDao</span> <span class="n">userDao</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">User</span> <span class="nf">findUserByName</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">userDao</span><span class="o">.</span><span class="na">selectByName</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">UsernameNotFoundException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">findUserByName</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h3 id="配置">配置<a href="#配置" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span>
  <span class="c1">//SecurityConfig继承自WebSecurityConfigurerAdapter 注意 需要加上@Configuration注解 否则配置将不会生效
</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.gdou.security.config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.gdou.security.JwtAuthenticationTokenFilter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.gdou.security.VO.ResultVOUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.gdou.security.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.gdou.security.service.UserService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.gdou.security.util.Demoutil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpMethod</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.authentication.AuthenticationProvider</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.authentication.BadCredentialsException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.authentication.UsernamePasswordAuthenticationToken</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.builders.HttpSecurity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.builders.WebSecurity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.http.SessionCreationPolicy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.Authentication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.AuthenticationException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.userdetails.UsernameNotFoundException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.crypto.password.Pbkdf2PasswordEncoder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.AuthenticationEntryPoint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.authentication.AuthenticationEntryPointFailureHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.authentication.AuthenticationFailureHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.authentication.AuthenticationSuccessHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.authentication.logout.LogoutSuccessHandler</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Objects</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @ProjectName: security
</span><span class="cm"> * @Package: com.gdou.security.config
</span><span class="cm"> * @ClassName: SecurityConfig
</span><span class="cm"> * @Author: carrymaniac
</span><span class="cm"> * @Description:
</span><span class="cm"> * @Date: 2020/2/11 3:54 下午
</span><span class="cm"> * @Version:
</span><span class="cm"> */</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="n">UserService</span> <span class="n">userService</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="n">JwtAuthenticationTokenFilter</span> <span class="n">filter</span><span class="o">;</span>
    <span class="cm">/**
</span><span class="cm">     * 配置权限用
</span><span class="cm">     * @param auth
</span><span class="cm">     * @throws Exception
</span><span class="cm">     */</span>

    <span class="c1">//AuthenticationManager：认证的核心接口
</span><span class="c1"></span>    <span class="c1">//AuthenticationManagerBuilder：用于构建AuthenticationManager的工具
</span><span class="c1"></span>    <span class="c1">//ProviderManger：AuthenticationManager的默认实现
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

<span class="c1">//        //1.内置的认证过程
</span><span class="c1">//        //简单的内置认证过程，auth会使用我们提供的userDetailsService
</span><span class="c1">//        //以及使用密码Encoder进行解密
</span><span class="c1">//        auth.userDetailsService(userService)
</span><span class="c1">//            .passwordEncoder(new Pbkdf2PasswordEncoder(&#34;12345&#34;));
</span><span class="c1">//
</span><span class="c1">//        //2.自定义认证规则
</span><span class="c1">//        // AuthenticationProvider: ProviderManager持有一组AuthenticationProvider,
</span><span class="c1">//        // 每个AuthenticationProvider负责一种认证.
</span><span class="c1">//        // 委托模式: ProviderManager将认证委托给AuthenticationProvider.
</span><span class="c1">//        auth.authenticationProvider(new AuthenticationProvider() {
</span><span class="c1">//            //定义认证过程
</span><span class="c1">//            @Override
</span><span class="c1">//            //Authentication用于封装认证信息的接口,不同的实现类代表不同的类型的认证信息（例如有账号密码认证，QQ认证，微信认证）
</span><span class="c1">//            public Authentication authenticate(Authentication authentication) throws AuthenticationException {
</span><span class="c1">//                String username = authentication.getName();
</span><span class="c1">//                String password = (String) authentication.getCredentials();
</span><span class="c1">//
</span><span class="c1">//                User user = userService.findUserByName(username);
</span><span class="c1">//                //正常逻辑拿到这些信息，会进行校验，比如说这个账号是否过期等等
</span><span class="c1">//                if(user==null){
</span><span class="c1">//                    //之后会有专门的Handler捕获这些Exception
</span><span class="c1">//                    throw new UsernameNotFoundException(&#34;账号不存在!&#34;);
</span><span class="c1">//                }
</span><span class="c1">//                password = Demoutil.md5(password + user.getSalt());
</span><span class="c1">//                if(!Objects.equals(password, user.getPassword())){
</span><span class="c1">//                    throw new BadCredentialsException(&#34;密码不正确!&#34;);
</span><span class="c1">//                }
</span><span class="c1">//                //返回接口实例
</span><span class="c1">//                return new UsernamePasswordAuthenticationToken(user,user.getPassword(),user.getAuthorities());
</span><span class="c1">//            }
</span><span class="c1">//
</span><span class="c1">//            //定义当前的AuthenticationProvider支持什么类型
</span><span class="c1">//            @Override
</span><span class="c1">//            public boolean supports(Class&lt;?&gt; aClass) {
</span><span class="c1">//                // UsernamePasswordAuthenticationToken: Authentication接口的常用的实现类.
</span><span class="c1">//                return UsernamePasswordAuthenticationToken.class.equals(aClass);
</span><span class="c1">//            }
</span><span class="c1">//        });
</span><span class="c1"></span>
        <span class="c1">//3.不使用SpringSecurity提供的认证方式而只使用它的认证逻辑，可以自己编写一套登录的逻辑
</span><span class="c1"></span>        <span class="c1">//然后使用一套Interceptor拦截器(比如在JWT中写Token用的Interceptor上,当确定用户有效的时候）
</span><span class="c1"></span>        <span class="c1">//手动的将Authentication写入到SecurityContextHolder中去，这样下面Security才能使用到Authentication
</span><span class="c1"></span>        <span class="c1">//具体查看JwtAuthenticationTokenFilter
</span><span class="c1"></span>    <span class="o">}</span>


    <span class="cm">/**
</span><span class="cm">     * 配置对请求的拦截的
</span><span class="cm">     * @param web
</span><span class="cm">     * @throws Exception
</span><span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">WebSecurity</span> <span class="n">web</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">//不拦截静态资源
</span><span class="c1"></span>        <span class="n">web</span><span class="o">.</span><span class="na">ignoring</span><span class="o">().</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">&#34;/resources/**&#34;</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="c1">//配置拦截的方式
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
<span class="c1">//        //对认证进行配置
</span><span class="c1">//        http.formLogin()
</span><span class="c1">////                .loginPage(&#34;/loginpage&#34;)
</span><span class="c1">//                .loginProcessingUrl(&#34;login&#34;)
</span><span class="c1">////                .successForwardUrl()
</span><span class="c1">////                .failureForwardUrl()
</span><span class="c1">//                .successHandler((request, response, authentication) -&gt; {
</span><span class="c1">//                    //这里进行登录成功之后的处理
</span><span class="c1">//                    response.setCharacterEncoding(&#34;UTF-8&#34;);
</span><span class="c1">//                    response.setContentType(&#34;application/json&#34;);
</span><span class="c1">//                    response.getWriter().println(&#34;{msg:登录成功,code:0}&#34;);
</span><span class="c1">//                    response.getWriter().flush();
</span><span class="c1">//                })
</span><span class="c1">//                .failureHandler((request, response, e) -&gt; {
</span><span class="c1">//                    //这里的e是之前跑出来的异常
</span><span class="c1">//                    response.setCharacterEncoding(&#34;UTF-8&#34;);
</span><span class="c1">//                    response.setContentType(&#34;application/json&#34;);
</span><span class="c1">//                    response.getWriter().println(&#34;{msg:登录失败,code:1}&#34;);
</span><span class="c1">//                    response.getWriter().flush();
</span><span class="c1">//                });
</span><span class="c1">//        http.logout()
</span><span class="c1">//                .logoutUrl(&#34;/logout&#34;)
</span><span class="c1">//                .logoutSuccessHandler((request, response, authentication) -&gt; {
</span><span class="c1">//                    //删除信息
</span><span class="c1">//                    response.setCharacterEncoding(&#34;UTF-8&#34;);
</span><span class="c1">//                    response.setContentType(&#34;application/json&#34;);
</span><span class="c1">//                    response.getWriter().println(&#34;{msg:登出成功,code:0}&#34;);
</span><span class="c1">//                    response.getWriter().flush();
</span><span class="c1">//                });
</span><span class="c1"></span>

        <span class="c1">//配置拦截
</span><span class="c1"></span>
            <span class="n">http</span><span class="o">.</span><span class="na">csrf</span><span class="o">()</span><span class="c1">// 由于使用的是JWT，我们这里不需要csrf
</span><span class="c1"></span>                <span class="o">.</span><span class="na">disable</span><span class="o">()</span>
                <span class="o">.</span><span class="na">sessionManagement</span><span class="o">()</span><span class="c1">// 基于token，所以不需要session
</span><span class="c1"></span>                <span class="o">.</span><span class="na">sessionCreationPolicy</span><span class="o">(</span><span class="n">SessionCreationPolicy</span><span class="o">.</span><span class="na">STATELESS</span><span class="o">)</span>
                <span class="o">.</span><span class="na">and</span><span class="o">()</span>
                <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="n">HttpMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="c1">// 允许对于网站静态资源的无授权访问
</span><span class="c1"></span>                        <span class="s">&#34;/&#34;</span><span class="o">,</span>
                        <span class="s">&#34;/*.html&#34;</span><span class="o">,</span>
                        <span class="s">&#34;/favicon.ico&#34;</span><span class="o">,</span>
                        <span class="s">&#34;/**/*.html&#34;</span><span class="o">,</span>
                        <span class="s">&#34;/**/*.css&#34;</span><span class="o">,</span>
                        <span class="s">&#34;/**/*.js&#34;</span><span class="o">,</span>
                        <span class="s">&#34;/swagger-resources/**&#34;</span><span class="o">,</span>
                        <span class="s">&#34;/v2/api-docs/**&#34;</span>
                <span class="o">)</span>
                <span class="o">.</span><span class="na">permitAll</span><span class="o">()</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">&#34;/user/login&#34;</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
<span class="c1">//                .antMatchers(&#34;/letter&#34;).hasAnyAuthority(&#34;USER&#34;, &#34;ADMIN&#34;)
</span><span class="c1">//                .antMatchers(&#34;/admin&#34;).hasAnyAuthority(&#34;ADMIN&#34;)
</span><span class="c1"></span>                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
                <span class="o">.</span><span class="na">and</span><span class="o">()</span>
                <span class="o">.</span><span class="na">exceptionHandling</span><span class="o">()</span>
                <span class="o">.</span><span class="na">accessDeniedHandler</span><span class="o">((</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">e</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="c1">//做对AccessDeniedException的处理
</span><span class="c1"></span>                    <span class="c1">//即授权问题的情况
</span><span class="c1"></span>                    <span class="n">response</span><span class="o">.</span><span class="na">setCharacterEncoding</span><span class="o">(</span><span class="s">&#34;UTF-8&#34;</span><span class="o">);</span>
                    <span class="n">response</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">&#34;application/json&#34;</span><span class="o">);</span>
                    <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">println</span><span class="o">(</span><span class="n">ResultVOUtil</span><span class="o">.</span><span class="na">fail</span><span class="o">(</span><span class="n">100</span><span class="o">,</span><span class="s">&#34;你没有权限&#34;</span><span class="o">));</span>
                    <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">flush</span><span class="o">();</span>
                <span class="o">})</span>
                <span class="o">.</span><span class="na">authenticationEntryPoint</span><span class="o">((</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">e</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="n">response</span><span class="o">.</span><span class="na">setCharacterEncoding</span><span class="o">(</span><span class="s">&#34;UTF-8&#34;</span><span class="o">);</span>
                    <span class="n">response</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">&#34;application/json&#34;</span><span class="o">);</span>
                    <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">println</span><span class="o">(</span><span class="n">ResultVOUtil</span><span class="o">.</span><span class="na">fail</span><span class="o">(</span><span class="n">100</span><span class="o">,</span> <span class="s">&#34;你未登陆&#34;</span><span class="o">));</span>
                    <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">flush</span><span class="o">();</span>
                    <span class="c1">//处理没有登陆的情况
</span><span class="c1"></span>                <span class="o">});</span>
        <span class="n">http</span><span class="o">.</span><span class="na">addFilterBefore</span><span class="o">(</span><span class="n">filter</span><span class="o">,</span> <span class="n">UsernamePasswordAuthenticationFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div><p>因为我们采用第三种认证方式，不使用不使用SpringSecurity提供的认证逻辑而只使用它的授权逻辑，因此我们要手动地将我们的身份认证注入到系统，以便于后面SpringSecurity使用该认证信息进行授权鉴定，其中的<code>JwtAuthenticationTokenFilter</code>,主要功能是在每次请求的时候，通过Request的tokenHeader拿到token，解析出用户信息，并将其转换为SpringSecurity的authentication，注入到系统中。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Slf4j</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JwtAuthenticationTokenFilter</span> <span class="kd">extends</span> <span class="n">OncePerRequestFilter</span> <span class="o">{</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${jwt.tokenHeader}&#34;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">tokenHeader</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${jwt.tokenHead}&#34;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">tokenHead</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">JwtTokenUtil</span> <span class="n">jwtTokenUtil</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="n">UserService</span> <span class="n">userService</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="n">HostHolder</span> <span class="n">hostHolder</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doFilterInternal</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;{}&#34;</span><span class="o">,</span><span class="k">this</span><span class="o">.</span><span class="na">tokenHeader</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">authHeader</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">tokenHeader</span><span class="o">);</span>
        <span class="c1">//拿到Token
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">authHeader</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">authHeader</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">tokenHead</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">authHeader</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">tokenHead</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
            <span class="n">String</span> <span class="n">userName</span> <span class="o">=</span> <span class="n">jwtTokenUtil</span><span class="o">.</span><span class="na">getUserNameFromToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">userName</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">getAuthentication</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">findUserByName</span><span class="o">(</span><span class="n">userName</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">jwtTokenUtil</span><span class="o">.</span><span class="na">validateToken</span><span class="o">(</span><span class="n">token</span><span class="o">,</span> <span class="n">user</span><span class="o">))</span> <span class="o">{</span>
                    <span class="c1">//将Authentication写到Context里去
</span><span class="c1"></span>                    <span class="n">UsernamePasswordAuthenticationToken</span> <span class="n">authentication</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">());</span>
                    <span class="n">authentication</span><span class="o">.</span><span class="na">setDetails</span><span class="o">(</span><span class="k">new</span> <span class="n">WebAuthenticationDetailsSource</span><span class="o">().</span><span class="na">buildDetails</span><span class="o">(</span><span class="n">request</span><span class="o">));</span>
                    <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">setAuthentication</span><span class="o">(</span><span class="n">authentication</span><span class="o">);</span>
                    <span class="n">hostHolder</span><span class="o">.</span><span class="na">setUser</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>其中的JWTUtil：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.gdou.security.util</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.jsonwebtoken.Claims</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.jsonwebtoken.Jwts</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.jsonwebtoken.SignatureAlgorithm</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.java.Log</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.userdetails.UserDetails</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @ProjectName: security
</span><span class="cm"> * @Package: com.gdou.security.util
</span><span class="cm"> * @ClassName: JwtTokenUtil
</span><span class="cm"> * @Author: carrymaniac
</span><span class="cm"> * @Description: jwt token生成用的工具类
</span><span class="cm"> * @Date: 2020/4/25 11:29 上午
</span><span class="cm"> * @Version:
</span><span class="cm"> */</span>
<span class="nd">@Component</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JwtTokenUtil</span> <span class="o">{</span>

    <span class="c1">//secret 用于加密
</span><span class="c1"></span>    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${jwt.secret}&#34;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">secret</span><span class="o">;</span>

    <span class="c1">//过期时间
</span><span class="c1"></span>    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${jwt.expiration}&#34;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">expiration</span><span class="o">;</span>

    <span class="n">String</span> <span class="n">CLAIM_KEY_USERNAME</span> <span class="o">=</span> <span class="s">&#34;sub&#34;</span><span class="o">;</span>
    <span class="n">String</span> <span class="n">CLAIM_KEY_CREATED</span> <span class="o">=</span> <span class="s">&#34;created&#34;</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 生成Token
</span><span class="cm">     * @param claims
</span><span class="cm">     * @return
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="nf">generateToken</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">claims</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">Jwts</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                <span class="c1">//负载
</span><span class="c1"></span>                <span class="o">.</span><span class="na">setClaims</span><span class="o">(</span><span class="n">claims</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setExpiration</span><span class="o">(</span><span class="n">generateExpirationDate</span><span class="o">())</span>
                <span class="o">.</span><span class="na">signWith</span><span class="o">(</span><span class="n">SignatureAlgorithm</span><span class="o">.</span><span class="na">HS512</span><span class="o">,</span><span class="n">secret</span><span class="o">)</span>
                <span class="o">.</span><span class="na">compact</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">Claims</span> <span class="nf">getClaimsFromToken</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">){</span>
        <span class="n">Claims</span> <span class="n">claims</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="n">claims</span> <span class="o">=</span> <span class="n">Jwts</span><span class="o">.</span><span class="na">parser</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">setSigningKey</span><span class="o">(</span><span class="n">secret</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">parseClaimsJws</span><span class="o">(</span><span class="n">token</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;JWT格式校验失败:{} &#34;</span><span class="o">,</span><span class="n">token</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">claims</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getUserNameFromToken</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">){</span>
        <span class="n">String</span> <span class="n">username</span><span class="o">;</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="n">Claims</span> <span class="n">claims</span> <span class="o">=</span> <span class="n">getClaimsFromToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">claims</span><span class="o">.</span><span class="na">getSubject</span><span class="o">();</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">username</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">username</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">validateToken</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">,</span> <span class="n">UserDetails</span> <span class="n">userDetails</span><span class="o">){</span>
        <span class="n">String</span> <span class="n">userName</span> <span class="o">=</span> <span class="n">getUserNameFromToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">userName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">userDetails</span><span class="o">.</span><span class="na">getUsername</span><span class="o">())</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isTokenExpired</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isTokenExpired</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Date</span> <span class="n">date</span> <span class="o">=</span> <span class="n">getExpiredDateFromToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">date</span><span class="o">.</span><span class="na">before</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">Date</span> <span class="nf">getExpiredDateFromToken</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Claims</span> <span class="n">claims</span> <span class="o">=</span> <span class="n">getClaimsFromToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">claims</span><span class="o">.</span><span class="na">getExpiration</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">generateToken</span><span class="o">(</span><span class="n">UserDetails</span> <span class="n">userDetails</span><span class="o">){</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">claims</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">claims</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">CLAIM_KEY_USERNAME</span><span class="o">,</span><span class="n">userDetails</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
        <span class="n">claims</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">CLAIM_KEY_CREATED</span><span class="o">,</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">generateToken</span><span class="o">(</span><span class="n">claims</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 刷新token
</span><span class="cm">     * 重新
</span><span class="cm">     * @param token
</span><span class="cm">     * @return
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">refreshToken</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">){</span>
        <span class="n">Claims</span> <span class="n">claims</span> <span class="o">=</span> <span class="n">getClaimsFromToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="n">claims</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">CLAIM_KEY_CREATED</span><span class="o">,</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">generateToken</span><span class="o">(</span><span class="n">claims</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 生成Token的过期时间
</span><span class="cm">     * @return 过期时间
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="nf">generateExpirationDate</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Date</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()+</span><span class="n">expiration</span><span class="o">*</span><span class="n">1000</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div><h3 id="controller">controller<a href="#controller" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>因为我采用了第三种的方式，因此我们要自己编写登录的逻辑</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.gdou.security.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.gdou.security.VO.ResultVO</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.gdou.security.VO.ResultVOUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.gdou.security.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.gdou.security.service.UserService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.gdou.security.util.Demoutil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.gdou.security.util.JwtTokenUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.*</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.sql.ResultSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Objects</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @ProjectName: security
</span><span class="cm"> * @Package: com.gdou.security.controller
</span><span class="cm"> * @ClassName: UserController
</span><span class="cm"> * @Author: carrymaniac
</span><span class="cm"> * @Description: user controller
</span><span class="cm"> * @Date: 2020/4/27 10:41 上午
</span><span class="cm"> * @Version:
</span><span class="cm"> */</span>
<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/user&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="n">JwtTokenUtil</span> <span class="n">jwtTokenUtil</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="n">UserService</span> <span class="n">userService</span><span class="o">;</span>
    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">&#34;login&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">ResultVO</span> <span class="nf">login</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&#34;username&#34;</span><span class="o">)</span> <span class="n">String</span> <span class="n">username</span><span class="o">,</span>
                          <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&#34;password&#34;</span><span class="o">)</span> <span class="n">String</span> <span class="n">password</span><span class="o">){</span>
                <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">findUserByName</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
                <span class="c1">//正常逻辑拿到这些信息，会进行校验，比如说这个账号是否过期等等
</span><span class="c1"></span>                <span class="k">if</span><span class="o">(</span><span class="n">user</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
                    <span class="c1">//之后会有专门的Handler捕获这些Exception
</span><span class="c1"></span>                    <span class="k">return</span> <span class="n">ResultVOUtil</span><span class="o">.</span><span class="na">fail</span><span class="o">(</span><span class="n">100</span><span class="o">,</span><span class="s">&#34;登陆失败&#34;</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">password</span> <span class="o">=</span> <span class="n">Demoutil</span><span class="o">.</span><span class="na">md5</span><span class="o">(</span><span class="n">password</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getSalt</span><span class="o">());</span>
                <span class="k">if</span><span class="o">(!</span><span class="n">Objects</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">password</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getPassword</span><span class="o">())){</span>
                    <span class="k">return</span> <span class="n">ResultVOUtil</span><span class="o">.</span><span class="na">fail</span><span class="o">(</span><span class="n">100</span><span class="o">,</span><span class="s">&#34;密码不正确&#34;</span><span class="o">);</span>
                <span class="o">}</span>
        <span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">jwtTokenUtil</span><span class="o">.</span><span class="na">generateToken</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">ResultVOUtil</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;testForLogin&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">ResultVO</span> <span class="nf">testFun</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">ResultVOUtil</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="s">&#34;你成功了&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;testForAdmin&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">ResultVO</span> <span class="nf">testFunForAdmin</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">ResultVOUtil</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="s">&#34;admin你成功了&#34;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div><h3 id="坑">坑<a href="#坑" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<h4 id="一">一<a href="#一" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">NoClassDefFoundError</span><span class="o">:</span> <span class="n">javax</span><span class="o">/</span><span class="n">xml</span><span class="o">/</span><span class="n">bind</span><span class="o">/</span><span class="n">DatatypeConverter</span>
</code></pre></div><p>当运行Jwts.builder().signWith的时候，系统报错，而这个错误在其余人的博文并没发生。查了一下找出了原因：</p>
<p><code>JAXB API是java EE 的API，因此在java SE 9.0 中不再包含这个 Jar 包。java 9 中引入了模块的概念，默认情况下，Java SE中将不再包含java EE 的Jar包而在 java 6/7 / 8 时关于这个API 都是捆绑在一起的</code></p>
<p>解决方案为加入缺失的包的依赖：</p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml">		<span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>javax.xml.bind<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>jaxb-api<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>2.3.0<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.sun.xml.bind<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>jaxb-impl<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>2.3.0<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.sun.xml.bind<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>jaxb-core<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>2.3.0<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>javax.activation<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>activation<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.1.1<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
</code></pre></div><h4 id="二">二<a href="#二" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p><code>@Value</code> 无法读取到值</p>
<p>原因：<code>使用@Value取值的类，需要是一个Spring装载的组件</code></p>
<p>解决方案：<code>加上@Component注解</code></p>

			</div>
			<hr class="post-end">
			<footer class="post-info">
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://carrymaniac.github.io/tags/spring">spring</a></span>
				</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>1285 Words</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2020-04-27 17:17 &#43;0800</p>
			</footer>
		</article>
		<aside id="toc">
			<div class="toc-title">Table of Contents</div>
			<nav id="TableOfContents">
  <ul>
    <li><a href="#jwt">JWT</a>
      <ul>
        <li><a href="#流程">流程</a></li>
        <li><a href="#格式">格式</a></li>
        <li><a href="#如何进行验证">如何进行验证</a></li>
      </ul>
    </li>
    <li><a href="#springsecurity">SpringSecurity</a></li>
    <li><a href="#代码实践">代码实践</a>
      <ul>
        <li><a href="#user实体类">User实体类</a></li>
        <li><a href="#userservice">UserService</a></li>
        <li><a href="#配置">配置</a></li>
        <li><a href="#controller">controller</a></li>
        <li><a href="#坑">坑</a></li>
      </ul>
    </li>
  </ul>
</nav>
		</aside>
		<div class="post-nav thin">
			<a class="next-post" href="https://carrymaniac.github.io/posts/my-chat/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;Newer</span><br><span>30分钟搭写一个聊天板</span>
			</a>
			<a class="prev-post" href="https://carrymaniac.github.io/posts/vue-learn/">
				<span class="post-nav-label">Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>小后台学Vue</span>
			</a>
		</div>
		<div id="comments" class="thin">
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2020 <a href="https://carrymaniac.github.io/">长门有一</a> &#183; <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="https://carrymaniac.github.io/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>



	<script src="https://carrymaniac.github.io/js/bundle.min.4a9a0ac3d2217822c7865b4161e6c2a71de1d70492264337755427898dd718f6.js" integrity="sha256-SpoKw9IheCLHhltBYebCpx3h1wSSJkM3dVQniY3XGPY=" crossorigin="anonymous"></script>
	

</body>

</html>
